# プロジェクト完成までのマイルストーン

本ドキュメントでは、オンライン対戦テトリスゲームを完成させるための開発マイルストーンを定義します。

---

## 現状の実装状況サマリー

### ✅ 実装済み（MVP機能）
- **バックエンド**
  - 基本的なテトリスゲームロジック（7種類のテトロミノ、回転、ライン消去）
  - マルチプレイヤー対応（最大8人 + 観戦者）
  - ペナルティシステム（2ライン以上消去で対戦相手に攻撃）
  - ルーム管理（作成、参加、退出、自動開始）
  - Socket.IO によるリアルタイム通信
  - スコア計算システム

- **フロントエンド**
  - Next.js 14 + App Router 構成
  - ゲームボード描画（10x20グリッド）
  - キーボード操作（左右移動、回転、ハードドロップ）
  - マルチプレイヤーのミニボード表示
  - チャットシステム
  - ルームロビー（作成・参加UI）
  - 観戦者モード対応

### ⚠️ 未実装・不完全な機能
- データベース連携（現在はインメモリ）
- ユーザー認証（現在はニックネームのみ）
- 永続化（ゲーム統計、リプレイ、ランキング）
- レベル・難易度システム
- 高度なテトリスルール（T-Spin、Back-to-Back ボーナス）
- 本番環境デプロイ（AWS構成）
- テストコード
- ロギング・モニタリング
- モバイル対応

---

## マイルストーン一覧

## 🎯 Phase 0: 基盤修正・安定化（2週間） ✅ **完了**
**目的**: 現在の実装バグを修正し、MVP として動作する状態にする

**完了日**: 2025-12-02

### タスク
- [x] フロントエンドの不具合修正
  - [x] `useEffect` の最適化とバグ修正 → React.memo、useCallback、useMemoで最適化
  - [x] TetrisGame コンポーネントが表示されない問題の解決 → nullチェックとフォールバック処理を追加
  - [x] ゲーム状態の同期ロジック修正 → syncRoomStateイベントを追加
- [x] エラーハンドリング強化
  - [x] Socket.IO 接続エラーの適切な処理 → エラーイベントハンドラを追加
  - [x] 再接続ロジックの実装 → 自動再接続（最大5回、1-5秒遅延）を実装
  - [x] ユーザー向けエラーメッセージの改善 → 状況に応じた詳細なエラーメッセージ
- [x] コード品質改善
  - [x] TypeScript の `any` 型を適切な型に置き換え → 型定義ファイル作成（frontend/src/types/game.ts）
  - [x] React最適化（memo, useCallback, useMemo）
  - [x] テストコード追加（統合テスト+3件）
- [x] 動作確認
  - [x] フロントエンドビルド成功確認
  - [x] バックエンドビルド成功確認
  - [x] テスト実行（フロントエンド: 40テスト、バックエンド: 72テスト）

**完了条件**:
- ✅ 主要な不具合が解消されている
- ✅ 型安全性が向上している
- ✅ エラーハンドリングが適切に実装されている
- ✅ テストカバレッジが十分である

### 実装の詳細

#### 1. TetrisGameコンポーネントの表示問題修正
- オプショナルチェーン（`?.`）を使用した安全なプロパティアクセス
- gameStateがnullまたはplayersが空の場合のフォールバック処理
- 空のボードを表示する防御的プログラミング

#### 2. TypeScript型定義の追加
**新規ファイル**: `frontend/src/types/game.ts`
- `GameState`: ゲーム全体の状態
- `PlayerState`: プレイヤーごとの状態
- `RoomInfo`: ルーム情報
- `ChatMessage`: チャットメッセージ
- すべてのコンポーネントで`any`型を排除

#### 3. Socket.IO再接続ロジック
- 自動再接続設定（reconnection: true, max: 5回）
- 再接続イベントハンドラ（reconnect, reconnect_attempt, reconnect_failed）
- サーバー切断時の手動再接続処理
- ユーザーへのリアルタイムフィードバック

#### 4. パフォーマンス最適化
- `React.memo`: TetrisBoard、MiniBoardコンポーネントをメモ化
- `useCallback`: GameRoomの全コールバック関数をメモ化
- `useMemo`: otherPlayers、myPlayerの計算をメモ化
- 不要な再レンダリングを防止

#### 5. 新機能の追加
- **syncRoomState**: 初期マウント時の状態同期イベント
- **joinRoomコールバック**: ルーム参加の成功/失敗を即座に通知
- **dynamic import + Suspense**: GameRoomの遅延ロード

#### 6. テストカバレッジ
- フロントエンド: 40テスト合格
- バックエンド: 72テスト合格
- 新規統合テスト: 3件追加
  - joinRoomコールバック（成功/失敗）
  - syncRoomStateイベント

---

## 🎯 Phase 1: コア機能拡張（3週間）
**目的**: ゲームとしての完成度を高め、ユーザー体験を向上させる

### 1.1 ゲームロジック改善
- [ ] レベルシステムの実装
  - [ ] ライン消去数に応じてレベル上昇
  - [ ] レベルに応じたブロック落下速度の変更
  - [ ] レベル表示UIの追加
- [ ] 高度なスコアリング
  - [ ] コンボボーナスの実装
  - [ ] T-Spin 検出とボーナス
  - [ ] Back-to-Back Tetris ボーナス
- [ ] ゲームバランス調整
  - [ ] ペナルティブロックの穴の数を調整可能に
  - [ ] 難易度設定の追加（初級・中級・上級）

### 1.2 UI/UX 改善
- [ ] ゲームアニメーション
  - [ ] ライン消去アニメーション
  - [ ] ブロック着地時のフィードバック
  - [ ] ペナルティ受信時のエフェクト
- [ ] サウンドエフェクト
  - [ ] ブロック移動音
  - [ ] ライン消去音
  - [ ] ゲームオーバー音
  - [ ] BGM（オプション）
- [ ] モバイル対応
  - [ ] レスポンシブデザイン
  - [ ] タッチ操作UI（仮想ボタン）
  - [ ] 画面サイズに応じたレイアウト調整
- [ ] アクセシビリティ
  - [ ] ARIA ラベルの追加
  - [ ] キーボードフォーカス管理
  - [ ] カラーブラインド対応モード

### 1.3 マルチプレイヤー機能強化
- [ ] ルームカスタマイズ
  - [ ] ルーム名の設定
  - [ ] パスワード保護
  - [ ] 最大人数設定
- [ ] 観戦機能
  - [ ] 観戦者専用チャット
  - [ ] カメラ切り替え（プレイヤー視点）
  - [ ] リプレイ機能
- [ ] ゲーム設定
  - [ ] 開始時のレベル設定
  - [ ] ペナルティ強度設定
  - [ ] ゲームモード（バトルロイヤル、チーム戦など）

**完了条件**:
- ✅ スマートフォンでも快適にプレイ可能
- ✅ 基本的なサウンドエフェクトが実装されている
- ✅ ルームカスタマイズ機能が動作している

---

## 🎯 Phase 2: データ永続化・認証（3週間）
**目的**: ユーザーデータを永続化し、本格的なオンラインゲームとして機能させる

### 2.1 データベース設計・実装
- [ ] データベーススキーマ設計
  - [ ] ユーザーテーブル（id, username, email, created_at など）
  - [ ] ゲームテーブル（id, room_id, players, winner, created_at など）
  - [ ] スコアテーブル（id, user_id, game_id, score, lines など）
- [ ] DynamoDB セットアップ
  - [ ] テーブル作成
  - [ ] インデックス設計（GSI）
  - [ ] 接続設定
- [ ] データアクセス層実装
  - [ ] ユーザーCRUD操作
  - [ ] ゲーム記録の保存
  - [ ] スコアクエリ（ランキング取得など）

### 2.2 ユーザー認証
- [ ] 認証システム選定
  - [ ] Amazon Cognito の導入検討
  - [ ] または自前実装（JWT + bcrypt）
- [ ] 認証機能実装
  - [ ] サインアップ
  - [ ] ログイン
  - [ ] パスワードリセット
  - [ ] セッション管理
- [ ] フロントエンド認証UI
  - [ ] ログイン画面
  - [ ] サインアップ画面
  - [ ] プロフィール画面

### 2.3 統計・ランキング
- [ ] ユーザー統計機能
  - [ ] 総ゲーム数、勝利数、敗北数
  - [ ] 平均スコア、最高スコア
  - [ ] プレイ時間統計
- [ ] ランキングシステム
  - [ ] グローバルランキング（最高スコア）
  - [ ] 週間ランキング
  - [ ] 友達ランキング
- [ ] UI実装
  - [ ] ランキングページ
  - [ ] プロフィールページ
  - [ ] 統計ダッシュボード

**完了条件**:
- ✅ ユーザー登録・ログインが動作している
- ✅ ゲーム結果がデータベースに保存されている
- ✅ ランキングページが表示される

---

## 🎯 Phase 3: テスト・品質保証（2週間）
**目的**: コードの品質を担保し、バグを最小化する

### 3.1 テスト実装
- [ ] バックエンドテスト
  - [ ] ユニットテスト（Jest）
    - [ ] ゲームロジック（TetrisGame, Piece, ScoreCalculator）
    - [ ] ルーム管理（Room, RoomManager）
    - [ ] ペナルティシステム
  - [ ] 統合テスト（Supertest）
    - [ ] Socket.IO イベントハンドラ
    - [ ] APIエンドポイント
  - [ ] カバレッジ目標: 80% 以上
- [ ] フロントエンドテスト
  - [ ] コンポーネントテスト（Vitest + React Testing Library）
    - [ ] TetrisBoard
    - [ ] TetrisGame
    - [ ] GameRoom
  - [ ] E2Eテスト（Playwright）
    - [ ] ルーム作成・参加フロー
    - [ ] ゲームプレイフロー
    - [ ] チャット送信
  - [ ] カバレッジ目標: 70% 以上

### 3.2 パフォーマンス最適化
- [ ] バックエンド最適化
  - [ ] ゲーム状態の差分送信（現在は全状態送信）
  - [ ] Socket.IO イベントのレート制限
  - [ ] メモリリーク調査・修正
- [ ] フロントエンド最適化
  - [ ] React Suspense への移行（useEffect 削減）
  - [ ] 不要な再レンダリングの抑制（React.memo, useMemo）
  - [ ] バンドルサイズ削減
- [ ] ネットワーク最適化
  - [ ] WebSocket 通信の圧縮
  - [ ] クライアント側予測実装（ラグ補償）

### 3.3 セキュリティ対策
- [ ] 入力バリデーション
  - [ ] ユーザー名のサニタイゼーション
  - [ ] チャットメッセージのXSS対策
  - [ ] ゲームアクション検証（チート対策）
- [ ] レート制限
  - [ ] Socket.IO イベントの送信頻度制限
  - [ ] API エンドポイントのレート制限
- [ ] セキュリティヘッダー
  - [ ] CSP（Content Security Policy）
  - [ ] CORS 設定の厳格化

**完了条件**:
- ✅ テストカバレッジが目標値に到達
- ✅ セキュリティ脆弱性スキャンで重大な問題なし
- ✅ ゲーム状態同期のレイテンシーが100ms以下

---

## 🎯 Phase 4: AWS デプロイ準備（3週間）
**目的**: 本番環境へのデプロイ準備を完了する

### 4.1 インフラ構築（Terraform）
- [ ] VPC ネットワーク設定
  - [ ] サブネット設計（Public/Private）
  - [ ] セキュリティグループ
  - [ ] NAT Gateway
- [ ] ECS Fargate クラスタ
  - [ ] タスク定義（バックエンド）
  - [ ] サービス設定（Auto Scaling）
  - [ ] ALB 設定
- [ ] DynamoDB
  - [ ] テーブル作成（Terraform）
  - [ ] Auto Scaling 設定
- [ ] ElastiCache (Redis)
  - [ ] クラスタ設定
  - [ ] セキュリティグループ
- [ ] S3 + CloudFront
  - [ ] バケット作成
  - [ ] CloudFront ディストリビューション
  - [ ] キャッシュ設定

### 4.2 CI/CD パイプライン
- [ ] GitHub Actions ワークフロー
  - [ ] リント・テストの自動実行
  - [ ] Docker イメージビルド
  - [ ] ECR へのプッシュ
  - [ ] ECS デプロイ
  - [ ] フロントエンドの S3 デプロイ
- [ ] 環境分離
  - [ ] 開発環境（dev）
  - [ ] ステージング環境（staging）
  - [ ] 本番環境（production）

### 4.3 モニタリング・ロギング
- [ ] CloudWatch 設定
  - [ ] メトリクス収集（CPU、メモリ、ネットワーク）
  - [ ] ログ集約（コンテナログ、アプリケーションログ）
  - [ ] アラート設定（エラー率、レスポンスタイム）
- [ ] X-Ray 統合
  - [ ] 分散トレーシング
  - [ ] パフォーマンスボトルネックの可視化
- [ ] ダッシュボード作成
  - [ ] リアルタイムアクティブユーザー数
  - [ ] ゲーム数・ルーム数
  - [ ] エラー率・レイテンシー

**完了条件**:
- ✅ Terraform でインフラが再現可能
- ✅ CI/CD パイプラインが動作している
- ✅ モニタリングダッシュボードが表示される

---

## 🎯 Phase 5: 本番デプロイ・運用開始（2週間）
**目的**: 本番環境にデプロイし、運用を開始する

### 5.1 本番デプロイ
- [ ] ステージング環境でのテスト
  - [ ] 負荷テスト（同時接続100人以上）
  - [ ] セキュリティスキャン
  - [ ] パフォーマンステスト
- [ ] 本番環境デプロイ
  - [ ] データベースマイグレーション
  - [ ] 環境変数設定
  - [ ] DNS 設定
  - [ ] SSL/TLS 証明書設定
- [ ] ローンチチェックリスト
  - [ ] バックアップ設定確認
  - [ ] ロールバック手順確認
  - [ ] 監視アラート確認

### 5.2 運用準備
- [ ] ドキュメント整備
  - [ ] 運用マニュアル
  - [ ] トラブルシューティングガイド
  - [ ] API ドキュメント
- [ ] サポート体制
  - [ ] 問い合わせフォーム
  - [ ] FAQ ページ
  - [ ] 利用規約・プライバシーポリシー
- [ ] マーケティング準備
  - [ ] ランディングページ
  - [ ] SNS アカウント
  - [ ] プレスリリース

### 5.3 初期運用
- [ ] ユーザーフィードバック収集
  - [ ] アンケート実施
  - [ ] バグレポート受付
  - [ ] 改善要望の整理
- [ ] パフォーマンスモニタリング
  - [ ] 日次レポート確認
  - [ ] ボトルネック特定・改善
- [ ] コスト最適化
  - [ ] 実際のコスト確認
  - [ ] リソース使用状況分析
  - [ ] 不要なリソースの削減

**完了条件**:
- ✅ 本番環境で安定稼働している
- ✅ ユーザーがアクセス可能
- ✅ 運用ドキュメントが整備されている

---

## 🎯 Phase 6: 追加機能・改善（継続的）
**目的**: ユーザーフィードバックをもとに継続的に改善する

### 候補機能
- [ ] ソーシャル機能
  - [ ] フレンド機能
  - [ ] プライベートルーム招待
  - [ ] チーム対戦
- [ ] ゲームモード追加
  - [ ] タイムアタック
  - [ ] スプリント（40ライン消去）
  - [ ] カスタムルール
- [ ] カスタマイズ機能
  - [ ] スキン・テーマ変更
  - [ ] ブロックデザインカスタマイズ
  - [ ] サウンド設定
- [ ] e-sports 機能
  - [ ] トーナメントモード
  - [ ] 観戦者数表示
  - [ ] リプレイ共有
- [ ] 収益化
  - [ ] 広告表示
  - [ ] プレミアム会員（広告なし、特別スキンなど）
  - [ ] 寄付・投げ銭機能

---

## 📊 各フェーズの期間サマリー

| Phase | 期間 | 主要成果物 |
|-------|------|-----------|
| Phase 0: 基盤修正・安定化 | 2週間 | 動作するMVP |
| Phase 1: コア機能拡張 | 3週間 | 完成度の高いゲーム体験 |
| Phase 2: データ永続化・認証 | 3週間 | ユーザー管理システム |
| Phase 3: テスト・品質保証 | 2週間 | 高品質なコードベース |
| Phase 4: AWS デプロイ準備 | 3週間 | 本番環境インフラ |
| Phase 5: 本番デプロイ・運用開始 | 2週間 | 公開サービス |
| **合計** | **15週間（約4ヶ月）** | **フル機能のオンラインテトリス** |

---

## 🎯 クリティカルパス

プロジェクト成功のために特に重要なマイルストーン：

1. **Phase 0 完了**: MVP が動作しないと以降の開発が無意味
2. **Phase 2 完了**: データ永続化なしでは本格的なサービスとして成立しない
3. **Phase 4 完了**: AWS デプロイできないと公開不可能
4. **Phase 3**: テストが不十分だと本番環境で致命的バグが発生するリスク

---

## 📝 推奨される開発順序

### 優先度 HIGH（必須）
- Phase 0: 基盤修正・安定化
- Phase 2: データ永続化・認証
- Phase 4: AWS デプロイ準備
- Phase 5: 本番デプロイ

### 優先度 MEDIUM（重要）
- Phase 1: コア機能拡張（レベルシステム、UI改善）
- Phase 3: テスト・品質保証

### 優先度 LOW（追加機能）
- Phase 1: サウンドエフェクト、高度なスコアリング
- Phase 6: 追加機能（ソーシャル、収益化など）

---

## 💡 成功のためのヒント

1. **小さくリリースする**: MVP をできるだけ早く公開し、フィードバックを得る
2. **テストを書く**: 後から書くのは困難。実装と並行してテストを書く
3. **コスト監視**: AWS コストは想定以上に膨らむ可能性があるため、初期から監視する
4. **パフォーマンス最優先**: リアルタイムゲームではレイテンシーが UX に直結する
5. **ドキュメントを書く**: 将来の自分や他の開発者のために、設計判断を記録する

---

**最終更新**: 2025-12-02
