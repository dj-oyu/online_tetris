# E2Eテスト手順書

本ドキュメントでは、オンライン対戦テトリスの**エンドツーエンド(E2E)テスト**の手順を定義します。

---

## 目的

E2Eテストは、実際のユーザーが操作するシナリオを再現し、システム全体が正常に動作することを確認します。

---

## テスト環境

### 前提条件
- バックエンドサーバーが起動している (`http://localhost:8080`)
- フロントエンドサーバーが起動している (`http://localhost:3000`)
- 2つ以上のブラウザウィンドウまたはタブを開ける環境

### 推奨ブラウザ
- Google Chrome (最新版)
- Firefox (最新版)
- Safari (最新版)

---

## テストケース一覧

## TC-E2E-001: 初回アクセスとユーザー登録

### 目的
初めてアクセスしたユーザーがニックネームを入力してゲームを開始できることを確認

### 手順
1. ブラウザを開き、`http://localhost:3000` にアクセス
2. ユーザー名入力フィールドが表示されることを確認
3. ユーザー名に「TestPlayer1」と入力
4. 送信ボタンをクリック

### 期待結果
- ✅ ユーザー名が localStorage に保存される
- ✅ ルームロビー画面が表示される
- ✅ 「ルーム作成」ボタンと「ルーム一覧」が表示される

### 評価基準
- すべての期待結果が満たされること

---

## TC-E2E-002: ルーム作成

### 目的
プレイヤーが新しいゲームルームを作成できることを確認

### 手順
1. TC-E2E-001 を完了
2. 「ルーム作成」ボタンをクリック
3. ルームが作成されることを確認

### 期待結果
- ✅ 新しいルームが作成される
- ✅ ルームIDが発行される
- ✅ 自動的にルーム画面に遷移する
- ✅ 「プレイヤー数: 1/8」と表示される
- ✅ 「Ready」ボタンが表示される

### 評価基準
- すべての期待結果が満たされること

---

## TC-E2E-003: 2人目のプレイヤーがルームに参加

### 目的
別のプレイヤーが既存のルームに参加できることを確認

### 手順
1. **ブラウザウィンドウ1**: TC-E2E-002 を完了（ルームを作成して待機）
2. **ブラウザウィンドウ2**: 新しいウィンドウで `http://localhost:3000` にアクセス
3. ユーザー名に「TestPlayer2」と入力
4. ルーム一覧から作成されたルームを確認
5. 「参加」ボタンをクリック

### 期待結果
- ✅ **ウィンドウ2**: ルームに参加できる
- ✅ **ウィンドウ1**: 「TestPlayer2が参加しました」というメッセージが表示される
- ✅ **両方**: 「プレイヤー数: 2/8」と表示される
- ✅ **両方**: チャットエリアにシステムメッセージが表示される

### 評価基準
- すべての期待結果が満たされること

---

## TC-E2E-004: チャット機能

### 目的
プレイヤー間でチャットメッセージを送受信できることを確認

### 手順
1. TC-E2E-003 を完了（2人がルームに参加）
2. **ウィンドウ1**: チャット入力欄に「Hello!」と入力
3. 送信ボタンをクリック
4. **ウィンドウ2**: メッセージが表示されることを確認
5. **ウィンドウ2**: チャット入力欄に「Hi!」と入力して送信

### 期待結果
- ✅ **ウィンドウ2**: 「TestPlayer1: Hello!」が表示される
- ✅ **ウィンドウ1**: 「TestPlayer2: Hi!」が表示される
- ✅ 送信者名とメッセージが正しく表示される
- ✅ メッセージの順序が正しい

### 評価基準
- すべての期待結果が満たされること

---

## TC-E2E-005: プレイヤーReady状態

### 目的
プレイヤーがReady状態を切り替えられることを確認

### 手順
1. TC-E2E-003 を完了
2. **ウィンドウ1**: 「Ready」ボタンをクリック
3. **ウィンドウ2**: Ready状態の更新を確認
4. **ウィンドウ2**: 「Ready」ボタンをクリック

### 期待結果
- ✅ **ウィンドウ1**: ボタンが「Ready」→「Cancel」に変化
- ✅ **ウィンドウ2**: Player1のReady状態が表示される
- ✅ 両プレイヤーがReadyになるとゲームが開始される可能性がある

### 評価基準
- すべての期待結果が満たされること

---

## TC-E2E-006: ゲーム開始

### 目的
2人以上のプレイヤーがReadyになるとゲームが開始されることを確認

### 手順
1. TC-E2E-005 を完了（両プレイヤーがReady）
2. ゲームが自動的に開始されることを確認

### 期待結果
- ✅ ゲームボード（10x20グリッド）が表示される
- ✅ 現在のテトロミノが表示される
- ✅ Next piece（次のピース）が表示される
- ✅ スコアが「0」で表示される
- ✅ 対戦相手のミニボードが表示される
- ✅ キーボード操作の説明が表示される

### 評価基準
- すべての期待結果が満たされること

---

## TC-E2E-007: テトロミノの基本操作

### 目的
プレイヤーがキーボードでテトロミノを操作できることを確認

### 手順
1. TC-E2E-006 を完了（ゲーム開始）
2. **ウィンドウ1**: 以下のキー操作を実行
   - ← (左矢印) を押す
   - → (右矢印) を押す
   - ↓ (下矢印) を押す
   - ↑ (上矢印) を押す（回転）
   - Z キーを押す（反時計回り回転）
   - Space キーを押す（ハードドロップ）

### 期待結果
- ✅ ← キー: ピースが左に移動
- ✅ → キー: ピースが右に移動
- ✅ ↓ キー: ピースが下に移動
- ✅ ↑ キー: ピースが時計回りに回転
- ✅ Z キー: ピースが反時計回りに回転
- ✅ Space キー: ピースが一番下まで即座に落下
- ✅ ボード上でピースが正しく表示される

### 評価基準
- すべてのキー操作が正常に動作すること

---

## TC-E2E-008: ライン消去とスコア計算

### 目的
ラインが埋まると消去され、スコアが加算されることを確認

### 手順
1. TC-E2E-006 を完了
2. **ウィンドウ1**: テトロミノを操作して1行を完全に埋める
3. ライン消去とスコア更新を確認
4. 複数行同時に消去（2行、3行、4行）を試みる

### 期待結果
- ✅ 1行消去: ラインが消え、スコアが +100 される
- ✅ 2行消去: スコアが +300 される
- ✅ 3行消去: スコアが +500 される
- ✅ 4行消去（Tetris）: スコアが +800 される
- ✅ 消去されたラインの上のブロックが下に落ちる
- ✅ 「Lines Cleared」カウンターが増加する

### 評価基準
- すべてのライン消去パターンが正常に動作すること

---

## TC-E2E-009: ペナルティシステム

### 目的
2行以上消去すると対戦相手にペナルティが送られることを確認

### 手順
1. TC-E2E-006 を完了（2人でゲーム中）
2. **ウィンドウ1**: 2行以上を同時に消去
3. **ウィンドウ2**: ペナルティブロックが追加されることを確認
4. **ウィンドウ1**: 統計情報で「Penalties Given」が増加することを確認
5. **ウィンドウ2**: 統計情報で「Penalties Received」が増加することを確認

### 期待結果
- ✅ **ウィンドウ2**: ボードの下部にグレーのペナルティブロックが追加される
- ✅ ペナルティブロックには1つの穴が開いている
- ✅ 既存のブロックが上に押し上げられる
- ✅ **ウィンドウ1**: 「Penalties Given: 1」と表示される
- ✅ **ウィンドウ2**: 「Penalties Received: 1」と表示される

### 評価基準
- ペナルティシステムが正常に動作すること

---

## TC-E2E-010: ゲームオーバー

### 目的
ブロックが天井に達するとゲームオーバーになることを確認

### 手順
1. TC-E2E-006 を完了
2. **ウィンドウ1**: 意図的にブロックを積み上げて天井に到達させる
3. ゲームオーバー表示を確認

### 期待結果
- ✅ 「GAME OVER」オーバーレイが表示される
- ✅ 最終スコアが表示される
- ✅ **ウィンドウ2**: 「TestPlayer1が敗北しました」というメッセージが表示される
- ✅ 負けたプレイヤーは観戦者モードになる

### 評価基準
- ゲームオーバー処理が正常に動作すること

---

## TC-E2E-011: 勝者判定

### 目的
最後まで残ったプレイヤーが勝者になることを確認

### 手順
1. TC-E2E-006 を完了（2人でゲーム中）
2. **ウィンドウ1**: 意図的にゲームオーバーになる
3. **ウィンドウ2**: 勝者判定を確認

### 期待結果
- ✅ **ウィンドウ2**: 「YOU WIN!」オーバーレイが表示される
- ✅ **ウィンドウ2**: 最終スコアと統計が表示される
- ✅ **ウィンドウ1**: 「TestPlayer2が勝利しました」というメッセージが表示される
- ✅ チャットに勝者のアナウンスが表示される

### 評価基準
- 勝者判定が正常に動作すること

---

## TC-E2E-012: 強制スタート（30秒タイムアウト）

### 目的
プレイヤーが30秒待機するとゲームが自動的に開始されることを確認

### 手順
1. TC-E2E-002 を完了（ルーム作成）
2. **ウィンドウ1**: Readyボタンを押さずに待機
3. 30秒経過を待つ
4. 強制スタートメッセージとゲーム開始を確認

### 期待結果
- ✅ 30秒後に「30秒経過で強制スタート」というアラートが表示される
- ✅ ゲームが自動的に開始される
- ✅ 1人でもゲームがプレイ可能

### 評価基準
- 強制スタート機能が正常に動作すること

---

## TC-E2E-013: プレイヤーの退出

### 目的
プレイヤーがルームから退出できることを確認

### 手順
1. TC-E2E-003 を完了（2人がルームに参加）
2. **ウィンドウ2**: 「退出」ボタンをクリック
3. **ウィンドウ1**: 退出通知を確認

### 期待結果
- ✅ **ウィンドウ2**: ルームロビーに戻る
- ✅ **ウィンドウ1**: 「TestPlayer2が退出しました」というメッセージが表示される
- ✅ **ウィンドウ1**: 「プレイヤー数: 1/8」に更新される

### 評価基準
- 退出機能が正常に動作すること

---

## TC-E2E-014: 接続断とリロード

### 目的
ページをリロードしたときの挙動を確認

### 手順
1. TC-E2E-003 を完了（2人がルームに参加）
2. **ウィンドウ2**: ページをリロード（F5）
3. 再接続の挙動を確認

### 期待結果
- ✅ **ウィンドウ2**: ユーザー名入力画面に戻る（または localStorage から復元）
- ✅ **ウィンドウ1**: 「TestPlayer2が退出しました」というメッセージが表示される
- ✅ 再度参加することでゲームを継続できる（現在の実装では新規参加扱い）

### 評価基準
- リロード時の挙動が予想通りであること

---

## TC-E2E-015: 8人同時プレイ

### 目的
最大人数（8人）が同時にプレイできることを確認

### 手順
1. 8つのブラウザウィンドウまたはタブを開く
2. それぞれ異なるユーザー名でログイン
3. 同じルームに全員参加
4. ゲームを開始

### 期待結果
- ✅ 8人全員がルームに参加できる
- ✅ 8人全員のミニボードが表示される
- ✅ ゲームが正常に進行する
- ✅ ペナルティが適切に分配される

### 評価基準
- 8人同時プレイが安定して動作すること

---

## TC-E2E-016: 観戦者モード

### 目的
9人目以降のプレイヤーが観戦者として参加できることを確認

### 手順
1. TC-E2E-015 を完了（8人がプレイ中）
2. 9人目のユーザーが同じルームに参加を試みる

### 期待結果
- ✅ 「観戦者として参加しました」というメッセージが表示される
- ✅ ゲームボードが表示される
- ✅ 操作はできない
- ✅ チャットは可能

### 評価基準
- 観戦者モードが正常に動作すること

---

## TC-E2E-017: 複数ルームの同時動作

### 目的
複数のルームが同時に動作することを確認

### 手順
1. **ルーム1**: 2人のプレイヤーでゲームを開始
2. **ルーム2**: 別の2人のプレイヤーで新しいルームを作成しゲームを開始
3. 両方のルームが独立して動作することを確認

### 期待結果
- ✅ 両ルームが独立して動作する
- ✅ ゲーム状態が混在しない
- ✅ チャットメッセージが他のルームに漏れない
- ✅ ペナルティが正しいルーム内で送受信される

### 評価基準
- 複数ルームが正常に独立して動作すること

---

## テスト実行記録テンプレート

### テスト実行日: YYYY-MM-DD
### テスト実施者: [名前]
### テスト環境:
- OS: [Windows/Mac/Linux]
- ブラウザ: [Chrome/Firefox/Safari] バージョン: [x.x.x]
- バックエンドバージョン: [x.x.x]
- フロントエンドバージョン: [x.x.x]

| テストケースID | 結果 | 備考 |
|---------------|------|------|
| TC-E2E-001 | ✅ PASS / ❌ FAIL | |
| TC-E2E-002 | ✅ PASS / ❌ FAIL | |
| TC-E2E-003 | ✅ PASS / ❌ FAIL | |
| TC-E2E-004 | ✅ PASS / ❌ FAIL | |
| TC-E2E-005 | ✅ PASS / ❌ FAIL | |
| TC-E2E-006 | ✅ PASS / ❌ FAIL | |
| TC-E2E-007 | ✅ PASS / ❌ FAIL | |
| TC-E2E-008 | ✅ PASS / ❌ FAIL | |
| TC-E2E-009 | ✅ PASS / ❌ FAIL | |
| TC-E2E-010 | ✅ PASS / ❌ FAIL | |
| TC-E2E-011 | ✅ PASS / ❌ FAIL | |
| TC-E2E-012 | ✅ PASS / ❌ FAIL | |
| TC-E2E-013 | ✅ PASS / ❌ FAIL | |
| TC-E2E-014 | ✅ PASS / ❌ FAIL | |
| TC-E2E-015 | ✅ PASS / ❌ FAIL | |
| TC-E2E-016 | ✅ PASS / ❌ FAIL | |
| TC-E2E-017 | ✅ PASS / ❌ FAIL | |

### 総合評価
- 合格: [ ] 件
- 不合格: [ ] 件
- 成功率: [ ]%

### 特記事項
-

---

## 自動化の推奨

上記のテストケースは、**Playwright** または **Cypress** を使用して自動化することを推奨します。

### Playwright 導入例

```bash
# frontend ディレクトリで実行
npm install -D @playwright/test
npx playwright install
```

### テストスクリプト例 (TC-E2E-001)

```typescript
import { test, expect } from '@playwright/test';

test('TC-E2E-001: 初回アクセスとユーザー登録', async ({ page }) => {
  await page.goto('http://localhost:3000');

  // ユーザー名入力フィールドが表示されることを確認
  const usernameInput = page.locator('input[type="text"]');
  await expect(usernameInput).toBeVisible();

  // ユーザー名を入力
  await usernameInput.fill('TestPlayer1');

  // 送信ボタンをクリック
  await page.click('button[type="submit"]');

  // ルームロビーが表示されることを確認
  await expect(page.locator('text=ルーム作成')).toBeVisible();
  await expect(page.locator('text=ルーム一覧')).toBeVisible();
});
```

---

**最終更新**: 2025-12-02
